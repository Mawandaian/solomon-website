<html>
  <head>
    <title>Admininstrator Home</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  </head>
  <body>
    <div class="container">
        <div class="destination_container">
            <h1>ADD DESTINATION</h1>
            <form action="http://127.0.0.1:5000/{{package_destination}}" method="post" id="destinationForm" onsubmit="return false;" enctype='multipart/form-data' >
                <input type="text" placeholder="New Destination Name" name="new_destination" value="{{
                    request.form.new_destination }}"><br />
                <p>Add Destination Image</p>
                <div id="destination_photo_holder">

                </div>
                <input class="btn btn-default" type="submit" id="destination_button" value="Post Destination">
            </form>
        </div>

        <div class="packages_container">
        <h1>PACKAGES</h1>
        <br>
        <div id="wait" style="display:none;width:69px;height:89px;border:1px solid black;position:absolute;top:50%;left:50%;padding:2px;"><img src='https://www.w3schools.com/jquery/demo_wait.gif' width="64" height="64" /><br>Loading..</div>
        <form action="http://127.0.0.1:5000/{{post_package}}" method="post" id="myForm" onsubmit="return false;" enctype='multipart/form-data' >
            <input type="text" placeholder="Package Name" name="package_name" value="{{
                request.form.package_name }}"><br />
            <input type="text" placeholder="Duration" name="duration" value="{{
                request.form.duration }}"><br />
            <input type="text" placeholder="Price" name="price" value="{{
                request.form.price }}"><br />
            <select name="destination">
                {% for key, value in destinations.items() %}
                    <option value="{{ key }}">{{ value }}</option>
                {% endfor %}
            </select>
            <input type="date" name="expiry_date" />
            <textarea placeholder="Details" name="details">{{ request.form.details }}</textarea><br />
        
                    <div id="photo_holder">
                        <br />
                        <input type="text" name="photo_counter" id="photo_counter" value="0" />
                        <br />
                        <div onclick="addImageTagsFunction(increment(), 'photo_holder')">Add Photo</div>
                    </div>

                    <div id="itinerary_holder">
                        <br />
                        <input type="text" name="itinerary_counter" id="itinerary_counter" value="0" />
                        <br />
                        <div onclick="addItineraryTagsFunction(itinerary_increment())">Add Itinerary</div>
                    </div>

            <input class="btn btn-default" type="submit" id="button" value="Post">
        </form>

        <script type="text/javascript">
            !function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Compress=e():t.Compress=e()}(this,function(){return function(t){function e(i){if(n[i])return n[i].exports;var r=n[i]={exports:{},id:i,loaded:!1};return t[i].call(r.exports,r,r.exports,e),r.loaded=!0,r.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){var i,r,a;!function(o,u){r=[t,n(1),n(2),n(3),n(4),n(5),n(6)],i=u,a="function"==typeof i?i.apply(e,r):i,!(void 0!==a&&(t.exports=a))}(this,function(t,e,n,i,r,a,o){"use strict";function u(t){return t&&t.__esModule?t:{default:t}}function s(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function f(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var d=u(e),l=u(n),c=u(i),h=u(r),v=u(a),p=u(o),g=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),w=function(){function t(){f(this,t)}return g(t,[{key:"attach",value:function(t,e){var n=this;return new Promise(function(i,r){var a=document.querySelector(t);a.setAttribute("accept","image/*"),a.addEventListener("change",function(t){var r=n.compress([].concat(s(t.target.files)),e);i(r)},!1)})}},{key:"compress",value:function(t,e){function n(t,e){var n=new v.default(e);return n.start=window.performance.now(),n.alt=t.name,n.ext=t.type,n.startSize=t.size,p.default.orientation(t).then(function(e){return n.orientation=e,c.default.load(t)}).then(i(n))}function i(t){return function(e){return h.default.load(e).then(function(e){if(t.startWidth=e.naturalWidth,t.startHeight=e.naturalHeight,t.resize){var n=h.default.resize(t.maxWidth,t.maxHeight)(e.naturalWidth,e.naturalHeight),i=n.width,r=n.height;t.endWidth=i,t.endHeight=r}else t.endWidth=e.naturalWidth,t.endHeight=e.naturalHeight;return l.default.imageToCanvas(t.endWidth,t.endHeight,t.orientation)(e)}).then(function(e){return t.iterations=1,t.base64prefix=d.default.prefix(t.ext),r(e,t.startSize,t.quality,t.size,t.minQuality,t.iterations)}).then(function(e){return t.finalSize=d.default.size(e),d.default.data(e)}).then(function(e){t.end=window.performance.now();var n=t.end-t.start;return{data:e,prefix:t.base64prefix,elapsedTimeInSeconds:n/1e3,alt:t.alt,initialSizeInMb:l.default.size(t.startSize).MB,endSizeInMb:l.default.size(t.finalSize).MB,ext:t.ext,quality:t.quality,endWidthInPx:t.endWidth,endHeightInPx:t.endHeight,initialWidthInPx:t.startWidth,initialHeightInPx:t.startHeight,sizeReducedInPercent:(t.startSize-t.finalSize)/t.startSize*100,iterations:t.iterations}})}}function r(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,i=arguments[3],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,o=arguments[5],u=l.default.canvasToBase64(t,n),s=d.default.size(u);return o+=1,s>i?r(t,s,n-.1,i,a,o):n>a?r(t,s,n-.1,i,a,o):n<.5?u:u}return Promise.all(t.map(function(t){return n(t,e)}))}}],[{key:"convertBase64ToFile",value:function(t,e){return l.default.base64ToFile(t,e)}}]),t}();t.exports=w})},function(t,e,n){var i,r,a;!function(n,o){r=[e],i=o,a="function"==typeof i?i.apply(e,r):i,!(void 0!==a&&(t.exports=a))}(this,function(t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var e=function(t){var e=t.replace(/^data:image\/\w+;base64,/,"").length;return(e-814)/1.37},n=function(t){return t.split(";")[0].match(/jpeg|png|gif/)[0]},i=function(t){return t.replace(/^data:image\/\w+;base64,/,"")},r=function(t){return"data:"+t+";base64,"};t.default={size:e,mime:n,data:i,prefix:r}})},function(t,e,n){var i,r,a;!function(n,o){r=[e],i=o,a="function"==typeof i?i.apply(e,r):i,!(void 0!==a&&(t.exports=a))}(this,function(t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var e=function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"image/jpeg",n=window.atob(t),i=[],r=0;r<n.length;r++)i[r]=n.charCodeAt(r);return new window.Blob([new Uint8Array(i)],{type:e})},n=function(t,e,n){var i=document.createElement("canvas"),r=i.getContext("2d");return i.width=t,i.height=e,function(a){if(!n||n>8)return r.drawImage(a,0,0,i.width,i.height),i;switch(n>4&&(i.width=e,i.height=t),n){case 2:r.translate(t,0),r.scale(-1,1);break;case 3:r.translate(t,e),r.rotate(Math.PI);break;case 4:r.translate(0,e),r.scale(1,-1);break;case 5:r.rotate(.5*Math.PI),r.scale(1,-1);break;case 6:r.rotate(.5*Math.PI),r.translate(0,-e);break;case 7:r.rotate(.5*Math.PI),r.translate(t,-e),r.scale(-1,1);break;case 8:r.rotate(-.5*Math.PI),r.translate(-t,0)}return n>4?r.drawImage(a,0,0,i.height,i.width):r.drawImage(a,0,0,i.width,i.height),i}},i=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.75,n=t.toDataURL("image/jpeg",e);return n},r=function(t){return{KB:t/1e3,MB:t/1e6}};t.default={base64ToFile:e,imageToCanvas:n,canvasToBase64:i,size:r}})},function(t,e,n){var i,r,a;!function(n,o){r=[e],i=o,a="function"==typeof i?i.apply(e,r):i,!(void 0!==a&&(t.exports=a))}(this,function(t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var e=function(t){return new Promise(function(e,n){var i=new window.FileReader;i.addEventListener("load",function(t){e(t.target.result)},!1),i.addEventListener("error",function(t){n(t)},!1),i.readAsDataURL(t)})};t.default={load:e}})},function(t,e,n){var i,r,a;!function(n,o){r=[e],i=o,a="function"==typeof i?i.apply(e,r):i,!(void 0!==a&&(t.exports=a))}(this,function(t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var e=function(t){return new Promise(function(e,n){var i=new window.Image;i.addEventListener("load",function(){e(i)},!1),i.addEventListener("error",function(t){n(t)},!1),i.src=t})},n=function(t,e){return function(n,i){if(!t&&!e)return{width:n,height:i};var r=Math.min(n,t),a=Math.min(i,e);if(r){var o=n/r,u=i/o;return{width:r,height:u}}var s=i/a,f=n/s;return{width:f,height:a}}};t.default={load:e,resize:n}})},function(t,e,n){var i,r,a;!function(n,o){r=[e],i=o,a="function"==typeof i?i.apply(e,r):i,!(void 0!==a&&(t.exports=a))}(this,function(t){"use strict";function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function t(n){var i=n.quality,r=void 0===i?.75:i,a=n.size,o=void 0===a?2:a,u=n.maxWidth,s=void 0===u?1920:u,f=n.maxHeight,d=void 0===f?1920:f,l=n.resize,c=void 0===l||l;e(this,t),this.start=window.performance.now(),this.end=null,this.alt=null,this.ext=null,this.startSize=null,this.startWidth=null,this.startHeight=null,this.size=1e3*o*1e3,this.endSize=null,this.endWidth=null,this.endHeight=null,this.iterations=0,this.base64prefix=null,this.quality=r,this.resize=c,this.maxWidth=s,this.maxHeight=d,this.orientation=1};t.default=n})},function(t,e,n){var i,r,a;!function(n,o){r=[e],i=o,a="function"==typeof i?i.apply(e,r):i,!(void 0!==a&&(t.exports=a))}(this,function(t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var e=function(t){return new Promise(function(e,n){var i=new window.FileReader;i.onload=function(t){var n=new DataView(t.target.result);65496!==n.getUint16(0,!1)&&e(-2);for(var i=n.byteLength,r=2;r<i;){var a=n.getUint16(r,!1);if(r+=2,65505===a){1165519206!==n.getUint32(r+=2,!1)&&e(-1);var o=18761===n.getUint16(r+=6,!1);r+=n.getUint32(r+4,o);var u=n.getUint16(r,o);r+=2;for(var s=0;s<u;s++)274===n.getUint16(r+12*s,o)&&e(n.getUint16(r+12*s+8,o))}else{if(65280!==(65280&a))break;r+=n.getUint16(r,!1)}}e(-1)},i.readAsArrayBuffer(t.slice(0,65536))})};t.default={orientation:e}})}])});
    //# sourceMappingURL=index.js.map
        </script>
        
        <script type="text/javascript">
            // JavaScript Document
    "use strict";

    let i = 0; /* Set Global Variable i */
    function increment(){
        i += 1; /* Function for automatic increment of field's "Name" attribute. */

        document.getElementById('photo_counter').value = i;
        return i
    }

    let itinerary_i = 0; /* Set Global Variable i */
    function itinerary_increment(){
        itinerary_i += 1; /* Function for automatic increment of field's "Name" attribute. */

        document.getElementById('itinerary_counter').value = itinerary_i;
        return itinerary_i
    }

    function addImageTagsFunction(id, parent_id){
        let file_tag = document.createElement("INPUT");
        file_tag.setAttribute("type", "file");
        file_tag.setAttribute("name", "file");
        file_tag.setAttribute("accept", "image/*");
        file_tag.setAttribute("id", "file" + id);
        
        let textarea_tag = document.createElement("TEXTAREA");
        textarea_tag.setAttribute("name", "photo_data_uri");
        textarea_tag.setAttribute("id", "photo_data_uri_" + id);

        let image_tag = document.createElement("IMG");
        image_tag.setAttribute("src", "/images/uploadButton.png");
        image_tag.setAttribute("name", "preview");
        image_tag.setAttribute("id", "preview_" + id);
        image_tag.setAttribute("width", "100px");

        
        document.getElementById(parent_id).appendChild(textarea_tag);
        document.getElementById(parent_id).appendChild(image_tag);
        document.getElementById(parent_id).appendChild(file_tag);

        addClickHandler('file' + id, 'preview_' + id, 'photo_data_uri_' + id)
    }


    function addItineraryTagsFunction(id){
        let file_tag = document.createElement("INPUT");
        file_tag.setAttribute("type", "file");
        file_tag.setAttribute("name", "itinerary_file");
        file_tag.setAttribute("accept", "image/*");
        file_tag.setAttribute("id", "itinerary_file_" + id);
        
        let textarea_tag = document.createElement("TEXTAREA");
        textarea_tag.setAttribute("name", "itinerary_photo_data_uri");
        textarea_tag.setAttribute("id", "itinerary_photo_data_uri_" + id);

        let image_tag = document.createElement("IMG");
        image_tag.setAttribute("src", "/images/uploadButton.png");
        image_tag.setAttribute("name", "itinerary_preview");
        image_tag.setAttribute("id", "itinerary_preview_" + id);
        image_tag.setAttribute("width", "100px");

        let itinerary_title = document.createElement("INPUT");
        itinerary_title.setAttribute("type", "text");
        itinerary_title.setAttribute("name", "itinerary_title_" + id);
        itinerary_title.setAttribute("id", "itinerary_title_" + id);
        itinerary_title.setAttribute("placeholder", "Itinerary Title");

        let itinerary_textarea_tag_details = document.createElement("TEXTAREA");
        itinerary_textarea_tag_details.setAttribute("name", "itinerary_details");
        itinerary_textarea_tag_details.setAttribute("id", "itinerary_details_" + id);
        itinerary_textarea_tag_details.setAttribute("placeholder", "Itinerary Details");

        
        document.getElementById("itinerary_holder").appendChild(textarea_tag);
        document.getElementById("itinerary_holder").appendChild(image_tag);
        document.getElementById("itinerary_holder").appendChild(file_tag);
        document.getElementById("itinerary_holder").appendChild(itinerary_title);
        document.getElementById("itinerary_holder").appendChild(itinerary_textarea_tag_details);

        addClickHandler('itinerary_file_' + id, 'itinerary_preview_' + id, 'itinerary_photo_data_uri_' + id)
    }


    const compressor = new Compress()
    let photo_array = new Array()

    function addClickHandler(elem, photo_preview, final_textarea){
        elem = document.getElementById(elem)
        let file_output = elem.addEventListener('change', function (evt){
            const files = [...evt.target.files]
            compressor.compress(files, {
                size: 4,
                quality: .75
            }).then((results) => {
                const output = results[0]
                const file = Compress.convertBase64ToFile(output.data, output.ext)
                document.getElementById(photo_preview).src = output.prefix + output.data
                document.getElementById(final_textarea).value = output.prefix + output.data
            })
        }, false)
    }

    $("#button").click(function () { 
        // Create a FormData and append the file with "image" as parameter name
        let form = document.getElementById('myForm');
        let formDataToUpload = new FormData(form);

        //Add package images
        let photo_data_uri = ''
        let counter = document.getElementById('photo_counter').value
        for(let i = 1; i <= counter; i++){
            photo_data_uri = document.getElementById('photo_data_uri_' + i).value
            formDataToUpload.append("photo"+i, photo_data_uri);
        }

        //Add package itinerary
        let itinerary_photo_data_uri = ''
        let itinerary_counter = document.getElementById('itinerary_counter').value
        for(let i = 1; i <= itinerary_counter; i++){
            let itinerary_title = document.getElementById('itinerary_title_' + i).value
            let itinerary_photo_data_uri = document.getElementById('itinerary_photo_data_uri_' + i).value
            let itinerary_details = document.getElementById('itinerary_details_' + i).value

            formDataToUpload.append("itinerary_photo"+i,itinerary_photo_data_uri)
            formDataToUpload.append('itinerary_title' + i, itinerary_title)
            formDataToUpload.append('itinerary_details' + i, itinerary_details)
        }

        for (let value of formDataToUpload) {
            console.log(value); 
        }

        $(document).ajaxStart(function(){
            $("#wait").css("display", "block");
        });

        $(document).ajaxComplete(function(){
            $("#wait").css("display", "none");
            //alert('Package added successfully')
        });

        $.ajax({
            url:"/receive_blob",
            data: formDataToUpload,// Add as Data the Previously create formData
            type:"POST",
            contentType:false,
            processData:false,
            cache:false,
            dataType:"json", // Change this according to your response from the server.
            error:function(err){
                console.error(err);
        },
        success:function(data){
            console.log(data);
        },
        complete:function(){
            console.log("Request finished.");
        },
        async:false
    });

    //form.innerHTML='<input type="text" placeholder="Package Name" name="package_name" value="{{request.form.package_name }}"><br /><input type="text" placeholder="Duration" name="duration" value="{{request.form.duration }}"><br /><input type="text" placeholder="Price" name="price" value="{{request.form.price }}"><br /><input type="text" placeholder="Destination" name="destination" value="{{request.form.destination }}"><br /><textarea placeholder="Details" name="details">{{ request.form.details }}</textarea><br /><div id="photo_holder"><br /><input type="text" name="photo_counter" id="photo_counter" value="0" /><br /><div onclick="addImageTagsFunction(increment(), "photo_holder")">Add Photo</div></div><div id="itinerary_holder"><br /><input type="text" name="itinerary_counter" id="itinerary_counter" value="0" /><br /><div onclick="addItineraryTagsFunction(itinerary_increment())">Add Itinerary</div></div><input class="btn btn-default" type="submit" id="button" value="Post">'
});
        </script>






        <script type="text/javascript">

            addImageTagsFunction('destination_increment_1', 'destination_photo_holder')

        $("#destination_button").click(function () { 
        // Create a FormData and append the file with "image" as parameter name
        let destinationForm = document.getElementById('destinationForm');
        let destinationFormDataToUpload = new FormData(destinationForm);
        
        $(document).ajaxStart(function(){
            $("#wait").css("display", "block");
        });

        $(document).ajaxComplete(function(){
            $("#wait").css("display", "none");
            //alert('Package added successfully')
        });

        $.ajax({
            url:"/receive_destination",
            data: destinationFormDataToUpload,// Add as Data the Previously create formData
            type:"POST",
            contentType:false,
            processData:false,
            cache:false,
            dataType:"json", // Change this according to your response from the server.
            error:function(err){
                console.error(err);
        },
        success:function(data){
            console.log(data);
        },
        complete:function(){
            console.log("Request finished.");
        },
        async:false
        });

        //destinationForm.innerHTML='<input type="text" placeholder="New Destination Name" name="new_destination" value="{{request.form.new_destination }}"><br /><p>Add Destination Image</p><div id="destination_photo_holder"></div><input class="btn btn-default" type="submit" id="destination_button" value="Post Destination">'
        //addImageTagsFunction('destination_increment_1', 'destination_photo_holder')
    });
        </script>

        {% if error %}
            <p class="error"><strong>Error:</strong> {{ error }}
        {% endif %}
        </div>
    </div>
  </body>
</html>